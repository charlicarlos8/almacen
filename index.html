<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Almacén Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librería para leer archivos Excel (.xlsx) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- App Wrapper -->
    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Header -->
        <header class="bg-indigo-700 text-white shadow-xl">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <i class="fas fa-warehouse text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight">Sistema de Almacén</h1>
                </div>
                
                <div class="flex items-center gap-3">
                    <label class="bg-indigo-600 hover:bg-indigo-500 transition-all px-5 py-2.5 rounded-xl cursor-pointer flex items-center gap-2 font-medium shadow-sm active:scale-95">
                        <i class="fas fa-file-excel"></i>
                        <span>Importar Excel (.xlsx)</span>
                        <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden">
                    </label>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-8 sm:px-6 lg:px-8">
            
            <!-- Notification Area -->
            <div id="status-container" class="hidden mb-6">
                <div id="status-message" class="p-4 rounded-xl border flex items-center gap-3 shadow-sm transition-all">
                    <!-- Icon and text injected here -->
                </div>
            </div>

            <!-- Search and Controls -->
            <div class="mb-8 space-y-4">
                <div class="relative group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Buscar por código, descripción o categoría..."
                        class="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all text-lg"
                    >
                </div>
            </div>

            <!-- Data Table Card -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse" id="inventory-table">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr id="table-headers">
                                <th class="px-6 py-4 text-sm font-semibold text-slate-500 italic">Esperando datos...</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="table-body">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading/Empty States -->
                <div id="loading-state" class="py-20 flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-indigo-500"></i>
                    <p class="text-lg font-medium">Sincronizando inventario...</p>
                </div>

                <div id="empty-state" class="hidden py-20 flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-database text-5xl mb-4 opacity-20"></i>
                    <p class="text-lg font-medium">No se encontraron productos</p>
                    <p class="text-sm">Prueba con otro término o importa un archivo de Excel</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-slate-200 py-6 mt-12">
            <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-slate-500">
                <div class="flex items-center gap-2">
                    <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Conectado a Firestore (Persistencia en la nube)
                </div>
                <div id="user-info">Cargando identidad...</div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE ENTORNO
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'almacen-excel-v1';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicialización
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de estado local
        let inventory = [];
        let currentUser = null;

        // --- FUNCIONES DE UI ---

        function showStatus(msg, type = 'info') {
            const container = document.getElementById('status-container');
            const messageDiv = document.getElementById('status-message');
            
            container.classList.remove('hidden');
            messageDiv.className = `p-4 rounded-xl border flex items-center gap-3 shadow-sm transition-all ${
                type === 'success' ? 'bg-emerald-50 border-emerald-100 text-emerald-800' : 
                type === 'error' ? 'bg-rose-50 border-rose-100 text-rose-800' : 
                'bg-blue-50 border-blue-100 text-blue-800'
            }`;

            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            messageDiv.innerHTML = `<i class="fas ${icon}"></i><p class="font-medium">${msg}</p>`;

            setTimeout(() => container.classList.add('hidden'), 5000);
        }

        function renderTable(data) {
            const headersRow = document.getElementById('table-headers');
            const body = document.getElementById('table-body');
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');

            loadingState.classList.add('hidden');
            
            if (data.length === 0) {
                emptyState.classList.remove('hidden');
                body.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');

            const keys = Object.keys(data[0]).filter(k => k !== 'id' && k !== 'updatedAt');
            headersRow.innerHTML = keys.map(key => `
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">
                    ${key.toUpperCase()}
                </th>
            `).join('');

            body.innerHTML = data.map(item => `
                <tr class="hover:bg-indigo-50/50 transition-colors border-b border-slate-50 last:border-0">
                    ${keys.map(key => `
                        <td class="px-6 py-4 text-sm text-slate-700 whitespace-nowrap">
                            ${item[key] !== undefined && item[key] !== null ? item[key] : '-'}
                        </td>
                    `).join('')}
                </tr>
            `).join('');
        }

        // --- LÓGICA DE NEGOCIO ---

        async function startAuth() {
            try {
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
                showStatus("Error de conexión con la base de datos.", "error");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-info').textContent = `Usuario: ${user.uid.substring(0, 8)}`;
                setupRealtimeListener();
            }
        });

        function setupRealtimeListener() {
            if (!currentUser) return;
            const inventoryCol = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
            
            onSnapshot(inventoryCol, (snapshot) => {
                inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFilter();
            }, (error) => {
                console.error("Snapshot error:", error);
                showStatus("Error al sincronizar datos.", "error");
            });
        }

        function applyFilter() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = inventory.filter(item => {
                return Object.values(item).some(val => 
                    String(val).toLowerCase().includes(term)
                );
            });
            renderTable(filtered);
        }

        // --- MANEJO DE EXCEL (.xlsx) ---
        document.getElementById('excel-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;

            showStatus("Leyendo archivo Excel...", "info");
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Tomamos la primera hoja del libro
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertimos a JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) throw new Error("Archivo vacío");

                    showStatus(`Subiendo ${jsonData.length} registros a la base de datos...`, "info");

                    for (const item of jsonData) {
                        // Limpiamos los nombres de las propiedades (evitar espacios o puntos)
                        const cleanedItem = {};
                        Object.keys(item).forEach(key => {
                            const cleanKey = key.trim().replace(/\./g, '_');
                            cleanedItem[cleanKey] = item[key];
                        });

                        // Identificador único: buscamos columnas comunes como "codigo" o "id"
                        const docId = String(cleanedItem.codigo || cleanedItem.id || cleanedItem.Codigo || `item_${Math.random().toString(36).substr(2, 9)}`);
                        
                        // Guardar en Firestore (Persistencia Real)
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', docId);
                        await setDoc(docRef, { 
                            ...cleanedItem, 
                            updatedAt: new Date().toISOString() 
                        });
                    }

                    showStatus("¡Base de datos actualizada correctamente!", "success");
                    e.target.value = ""; 
                } catch (err) {
                    console.error("Excel error:", err);
                    showStatus("Error al procesar el Excel. Asegúrate que el formato sea correcto.", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('search-input').addEventListener('input', applyFilter);
        window.onload = startAuth;

    </script>
</body>
</html>
